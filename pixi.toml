[workspace]
authors = [
    "Alexis Placet <alexis.placet@quantstack.net>",
    "Johan Mabille <johan.mabille@quantstack.net>",
]
name = "sparrow_rockfinch"
homepage = "https://github.com/sparrow-org/sparrow-rockfinch"
repository = "https://github.com/sparrow-org/sparrow-rockfinch"
version = "0.1.0"
description = "High-performance Arrow array library for Python with zero-copy data exchange"
license = "Apache-2.0"
readme = "README.md"
channels = ["conda-forge"]
platforms = ["osx-arm64", "linux-64", "osx-64", "win-64"]
preview = ["pixi-build"]
build-variants = { python = ["3.11.*"] }

[package]
name = "sparrow_rockfinch"
version = "0.1.0"

[package.build.backend]
channels = [
    "https://prefix.dev/pixi-build-backends",
    "https://prefix.dev/conda-forge",
]
name = "pixi-build-cmake"
version = "*"

[dependencies]
sparrow_rockfinch = { path = "." }

[package.build-dependencies]
cmake = ">=4.0"
ninja = ">=1.13"

[package.host-dependencies]
python = "*"  # Allow all variants
nanobind = "2.4.*"
sparrow = ">=2.0.0"
sparrow-devel = ">=2.0.0"

[package.run-dependencies]
python = "*"
sparrow = ">=2.0.0"

[tasks.build]
cmd = [
  "cmake",
  "-GNinja",
  "-S.",
  "-B.build",
  "-DCMAKE_BUILD_TYPE=Release",
  "-DFETCH_DEPENDENCIES_WITH_CMAKE=OFF",
]

[tasks.clean]
cmd = "rm -rf .build dist"
description = "Remove build artifacts and conda packages"

[feature.test.tasks.configure]
cmd = [
  "cmake",
  "-GNinja",
  "-S.",
  "-B.build",
  "-DCMAKE_BUILD_TYPE=Release",
  "-DFETCH_DEPENDENCIES_WITH_CMAKE=OFF",
  "-DSPARROW_ROCKFINCH_BUILD_TESTS=ON"
]

[feature.test.tasks.build]
cmd = "cmake --build .build"
depends-on = [
  { task = "configure", environment = "dev" }
]

[feature.test.tasks.test_cpp]
cmd = "cmake --build .build --target run_tests"
depends-on = [
  { task = "configure", environment = "dev" }
]

[tasks]
# start = "python -c 'import importlib.util; print(importlib.util.find_spec('sparrow_rockfinch'))'"
start = "python -c 'import sparrow_rockfinch; print(sparrow_rockfinch.__doc__)'"
# start = "python -c 'import sparrow_rockfinch; import inspect; print([name for name, obj in inspect.getmembers(sparrow_rockfinch, inspect.isclass)])'" 

[feature.test.tasks.test_python]
cmd = "cmake --build .build --target run_sparrow_tests_direct"
depends-on = [
  { task = "configure", environment = "dev" }
]

[feature.test.tasks.all_tests]
depends-on = ["test_cpp", "test_python"]
description = "Run all C++ and Python tests"

[feature.test.dependencies]
pytest = ">=7.0"
polars = ">=0.20"
pyarrow = ">=14.0"
doctest = ">=2.4"
sparrow-devel = ">=2.0.0"
nanobind = "2.4.*"

[feature.package-test.tasks.build_package]
cmd = "mkdir -p dist && pixi build --output-dir dist"
description = "Build the conda package"

[feature.package-test.tasks.create_test_env]
cmd = "micromamba create -n env_name python=3.11 -y"
description = "Create a test environment with micromamba"

[feature.package-test.tasks.install_package]
cmd = "micromamba install -y -n env_name ./dist/sparrow_rockfinch-0.1.0-py311he8c1319_0.conda pytest polars pyarrow -c conda-forge"
depends-on = ["build_package", "create_test_env"]
description = "Install the built conda package with micromamba"

[feature.package-test.tasks.test_package]
description = "Run integration tests using the micromamba environment"
cmd = "micromamba run -n env_name python -m pytest ./test/test_package_integration.py"
depends-on = ["install_package"]

[feature.package-test.tasks.test_import]
cmd = "micromamba run -n env_name python -c \"import sparrow_rockfinch; print('Successfully imported sparrow_rockfinch')\""
depends-on = ["install_package"]
description = "Quick import test of the installed package"

[feature.package-test.tasks.package_tests]
depends-on = ["test_import", "test_package"]
description = "Run all package tests (import + integration tests)"

[feature.package-test.dependencies]
python = "3.11.*"
pytest = ">=7.0"
polars = ">=0.20"
pyarrow = ">=14.0"
micromamba = ">=2.4"

[environments]
default = { features = [], solve-group = "default" }
dev = { features = ["test"], solve-group = "default" }
package-test = { features = ["package-test"], solve-group = "package-test" }